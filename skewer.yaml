title: Skupper Hello World using YAML
subtitle: A minimal HTTP application deployed across Kubernetes clusters using Skupper
overview: |
  This example is a variant of [Skupper Hello World][hello-world] that
  is deployed using YAML custom resources instead of imperative
  commands.

  It contains two services:

  * A backend service that exposes an `/api/hello` endpoint.  It
    returns greetings of the form `Hi, <your-name>.  I am <my-name>
    (<pod-name>)`.

  * A frontend service that sends greetings to the backend and
    fetches new greetings in response.

  In this scenario, each service runs in a different Kubernetes
  cluster.  The frontend runs in a namespace on cluster 1 called West,
  and the backend runs in a namespace on cluster 2 called East.

  <img src="images/entities.svg" width="640"/>

  Skupper enables you to place the backend in one cluster and the
  frontend in another and maintain connectivity between the two
  services without exposing the backend to the public internet.

  [hello-world]: https://github.com/skupperproject/skupper-example-hello-world
sites:
  west:
    title: West
    platform: kubernetes
    namespace: west
    env:
      KUBECONFIG: ~/.kube/config-west
  east:
    title: East
    platform: kubernetes
    namespace: east
    env:
      KUBECONFIG: ~/.kube/config-east
steps:
  - standard: kubernetes/set_up_your_clusters
  - standard: kubernetes/install_skupper_on_your_clusters
  - title: Apply your YAML resources
    preamble: |
      To configure our example sites and service bindings, we are
      using the following resources:

      West:

      * [site.yaml](west/site.yaml) - The Skupper _Site_ resource for
        West
      * [frontend.yaml](west/frontend.yaml) - The Hello World frontend
        deployment
      * [listener.yaml](west/listener.yaml) - A Skupper _Listener_
        resource for exposing the backend in East to the local
        frontend

      East:

      * [site.yaml](east/site.yaml) - The Skupper _Site_ resource for
        East
      * [backend.yaml](east/backend.yaml) - The Hello World backend
        deployment
      * [connector.yaml](east/connector.yaml) - A Skupper _Connector_
        resource for binding the backend to the listener in West

      Let's look at these resources in more detail.

      #### Resources in West

      The _Site_ resource defines a Skupper site for its associated
      Kubernetes namespace.  This is where you set site configuration
      options.  See the [Site configuration reference][site-config]
      for more information.

      The `linkAccess: default` field configures site West to accept
      site-to-site links.  This example creates a link from East to
      West, so the receiving side, West, must enable link access.

      [site-config]: https://skupperproject.github.io/refdog/resources/site.html

      [site.yaml](west/site.yaml):

      ~~~ yaml
      apiVersion: skupper.io/v1alpha1
      kind: Site
      metadata:
        name: west
        namespace: west
      spec:
        linkAccess: default
      ~~~

      The frontend is a standard Kubernetes deployment.

      [frontend.yaml](west/frontend.yaml):

      ~~~ yaml
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: frontend
        labels:
          app: frontend
      spec:
        selector:
          matchLabels:
            app: frontend
        replicas: 1
        template:
          metadata:
            labels:
              app: frontend
          spec:
            containers:
              - name: frontend
                image: quay.io/skupper/hello-world-frontend
                ports:
                  - containerPort: 8080
      ~~~

      The code in frontend makes API calls to
      `http://backend:8080/api/hello`.  The _Listener_ resource below
      configures the router to expose a connection endpoint at
      `backend:8080` and forward any connections there to routers in
      remote sites using the routing key `backend`.

      [listener.yaml](west/listener.yaml):

      ~~~ yaml
      apiVersion: skupper.io/v1alpha1
      kind: Listener
      metadata:
        name: backend
        namespace: west
      spec:
        port: 8080
        host: backend
        routingKey: backend
      ~~~

      #### Resources in East

      The _Site_ resource for East.

      [site.yaml](east/site.yaml):

      ~~~ yaml
      apiVersion: skupper.io/v1alpha1
      kind: Site
      metadata:
        name: east
        namespace: east
      ~~~

      The backend is a standard Kubernetes deployment.

      [backend.yaml](east/backend.yaml):

      ~~~ yaml
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: backend
        labels:
          app: backend
      spec:
        selector:
          matchLabels:
            app: backend
        replicas: 3
        template:
          metadata:
            labels:
              app: backend
          spec:
            containers:
              - name: backend
                image: quay.io/skupper/hello-world-backend
                ports:
                  - containerPort: 8080
      ~~~

      The _Connector_ resource below configures the router to take
      remote connections with routing key `backend` and forward them
      to port 8080 on pods matching the selector `app=backend`.

      [connector.yaml](east/connector.yaml):

      ~~~ yaml
      apiVersion: skupper.io/v1alpha1
      kind: Connector
      metadata:
        name: backend
        namespace: east
      spec:
        routingKey: backend
        port: 8080
        selector: app=backend
      ~~~
    commands:
      west:
        - run: kubectl apply -f west/site.yaml -f west/frontend.yaml -f west/listener.yaml
          output: |
            site.skupper.io/west created
            deployment.apps/frontend created
            listener.skupper.io/backend created
        - run: kubectl wait site/west --for condition=Ready --timeout 120s
        - await_resource: deployment/frontend
      east:
        - run: kubectl apply -f east/site.yaml -f east/backend.yaml -f east/connector.yaml
          output: |
            site.skupper.io/east created
            deployment.apps/backend created
            connector.skupper.io/backend created
        - run: kubectl wait site/east --for condition=Ready --timeout 120s
        - await_resource: deployment/backend
  - standard: kubernetes/link_your_sites
    preamble: |
      You can configure sites and service bindings declaratively, but
      linking sites is different.  To create a link, you must have the
      authentication secret and connection details of the remote site.
      Since these cannot be known in advance, linking must be
      procedural.

      <!--
      **Note:** There are several ways to automate the generation and
      distribution of tokens across sites, using for example Ansible,
      Backstage, or Vault.  See [Token distribution][XXX] for more
      information.
      -->

      This example uses the Skupper command-line tool to generate the
      secret token in West and create the link in East.

      To install the Skupper command:

      ~~~ shell
      curl https://skupper.io/install.sh | sh -s -- --version 2.0.0-preview-1
      ~~~

      For more installation options, see [Installing
      Skupper][install].

      Once the command is installed, use `skupper token create` in
      West to generate the token.  Then, use `skupper link create` in
      East to create a link.

      [install]: https://skupper.io/install/index.html
  - standard: hello_world/access_the_frontend
  - standard: kubernetes/cleaning_up
    commands:
      west:
        - run: kubectl delete -f west/site.yaml -f west/frontend.yaml -f west/listener.yaml --ignore-not-found
        - run: kubectl delete -f https://skupper.io/v2/install.yaml --ignore-not-found
      east:
        - run: kubectl delete -f east/site.yaml -f east/backend.yaml -f east/connector.yaml --ignore-not-found
        - run: kubectl delete -f https://skupper.io/v2/install.yaml --ignore-not-found
